#!/usr/bin/env ruby
require "json"
require "pp"
require "shellwords"

filename = Dir.glob("#{ENV['HOME']}/.mozilla/firefox/*.default/downloads.json").first
if !filename
  puts "No downloads in progress"
  exit
end
json = File.read(filename)
downloads = JSON.parse(json)

def download(d)
  url = d["source"]
  url = url["url"] if url.is_a? Hash

  part_file = d["target"]["partFilePath"]
  file = d["target"]["path"]
  canceled = d["canceled"] || d["error"]
  if !canceled
    puts "NOT paused in Firefox: #{file}"
    return
  end

  command = ["wget", "--read-timeout=60", "--no-use-server-timestamps", "-c",  "-O", part_file, url]
  puts command.map(&:shellescape).join(" ")
  result = system(*command)
  if result
    system "mv", part_file, file
  else
    puts "Failed"
    pp result
    pp $?
  end
rescue Interrupt
  puts "\nInterrupt (sleeping 2s before proceeding with next file)"
  sleep 2
end

downloads["list"].each do |item|
  download item
end
